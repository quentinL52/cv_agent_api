# === CV splitter ===

split_cv_task:
  description: >
    Découpe le CV en sections JSON. Copie le texte brut sans reformuler ni résumer.

    TEXTE PRINCIPAL DU CV (Markdown) :
    "{cv_content}"

    TEXTE BRUT PREMIÈRE PAGE (extraction directe, utilise-le si le texte principal manque le header) :
    "{cv_raw_start}"

    RÈGLES STRICTES :
    1. "header" : Les premières lignes du CV — contient le NOM du candidat, son TITRE/POSTE, ses coordonnées (email, téléphone, LinkedIn, ville). Cherche en priorité dans le TEXTE BRUT PREMIÈRE PAGE car le Markdown peut mal ordonner le header.
    2. "experiences" : Uniquement l'historique professionnel (Entreprise, Poste, Dates, missions).
    3. "projects" : Sections explicitement titrées "Projets". Laisser VIDE si absent, ne pas inventer.
    4. "skills" : Listes de compétences, langages, outils.
    5. "education" : Diplômes et formations.
    6. "languages" : Langues mentionnées avec leur niveau (Français, Anglais, etc.).
  expected_output: >
    Un objet JSON valide strictement structuré ainsi :
    {{
      "header": "texte brut du header (nom, titre, contact)...",
      "experiences": "texte brut...",
      "projects": "texte brut...",
      "education": "texte brut...",
      "skills": "texte brut...",
      "languages": "texte brut..."
    }}

# === Tache d'extractions des informations === 

skills_task:
  description: >
    Analyse les sections suivantes pour lister les compétences avec leur contexte d'utilisation.
    Expériences : {experiences}
    Projets : {projects}
    academique : {education}
    Skills Explicit : {skills}
    
    RÈGLES DE CLASSIFICATION :
    1. 'hard_skills' : Outils, langages, technos (ex: Python, SQL, Excel, React, FastAPI, LangChain).
       IMPORTANT: Inclure TOUTES les technologies mentionnées dans les projets, expériences et académique.
    2. 'soft_skills' : Qualités humaines (ex: Leadership, Communication, Rigueur).
    3. NE PAS INVENTER. Si ce n'est pas écrit, ne l'ajoute pas.
    4. Pour chaque skill, indique si elle est présente dans une expérience, un projet, academique, sans contexte, si elle est presente dans plusieurs section indique le .
  expected_output: >
    JSON : {{
      "hard_skills": ["Python", "SQL", "FastAPI"],
      "soft_skills": ["Rigueur", "Leadership"],
      "skills_with_context": [
        {{"skill": "Python", "context": "projet"}},
        {{"skill": "FastAPI", "context": "entreprise"}}
      ]
    }}

experience_task:
  description: >
    Tu es un extracteur de données strict. Analyse ce texte d'expérience :
    "{experiences}"
    
    Pour CHAQUE poste identifié :
    1. Titre du poste
    2. Nom de l'entreprise
    3. Dates (Début - Fin)
    4. Description (Liste des tâches/responsabilités)
    
    RÈGLE : Ne confonds PAS les projets scolaires avec des expériences pro. Les stages et alternances SONT des expériences.
  expected_output: >
    Liste JSON : [{{"Poste": "...", "Entreprise": "...", "start_date": "...", "end_date": "...", "responsabilités": ["task 1", "task 2"]}}]

project_task:
  description: >
    Analyse ce texte de projets : "{projects}"
    
    RÈGLES STRICTES DE STRUCTURE :
    Chaque projet DOIT avoir exactement ces clés :
    - "title" : Titre du projet
    - "technologies" : Liste de strings (Ex: ["Python", "React"])
    - "outcomes" : Liste de strings décrivant les résultats ou fonctionnalités (Ex: ["Appli déployée", "User base x2"])
    - "domaine metier" : (exemple un projet en lien avec la recommandation d'emploi est classé comme recrutement/RH)
    
    Sépare :
    - "professional" : Projets réalisés en entreprise (distincts du simple poste).
    - "personal" : Projets perso, Github, Hackathons, Écoles.
    
    Si une liste est vide, renvoie [].
  expected_output: >
    JSON : {{
      "professional": [
        {{ "title": "Data Jobs", "technologies": ["Python", "API"], "outcomes": ["App crée", "Optimisation X"], "domaine metier": "recrutement/RH" }}
      ], 
      "personal": []
    }}

education_task:
  description: >
    Analyse la section education : "{education}"
    Extrait les diplômes.
  expected_output: >
    Liste JSON : [{{"degree": "...", "institution": "...", "start_date": "...", "end_date": "..."}}]

reconversion_task:
  description: >
    Analyse les expériences : "{experiences}"
    Et "{education}"
    Le candidat est-il en reconversion ? (Changement majeur de domaine récent).
    indique aussi le contexte (de quelle domaine ou poste vient t'il et quelle est sa réortientation)
    pour le contexte de reconversion tu dois prendre en compte les experience et les education.
  expected_output: >
    JSON : {{"reconversion_analysis": {{"is_reconversion": true/false, "context": "..."}}

etudiant_task:
  description: >
    Analyse la section education : "{education}"
    Nous sommes le {current_date}.
    Le candidat est-il ACTUELLEMENT étuditant ? 
    CRITÈRES :
    1. Regarde les dates de fin des formations.
    2. Identifie la date de fin de la formation la plus récente.
    3. Si cette date est FUTURE par rapport à {current_date} ou si c'est écrit "En cours" / "Présent", alors is_etudiant = true.
    4. Récupère explicitement cette date sous le champ 'latest_education_end_date' (format YYYY-MM-DD ou MM/YYYY ou "Present").
    5. indique aussi le niveau d'études (ex: bac+2, bac+5) du diplome le plus proche de {current_date}.
    6. indique la spécialité exemple: ingenieur IA, data analyste, devellopeur frontend, etc.
  expected_output: >
    JSON : {{"etudiant_analysis": {{"is_etudiant": true/false, "niveau_etudes": "bac+5", "specialite": "data analyste", "latest_education_end_date": "YYYY-MM-DD"}}}}

language_task:
  description: >
    Identifie toutes les langues parlées par le candidat.

    SECTION LANGUES (extraite) : "{languages}"

    DÉBUT DU CV (pour détecter la langue de rédaction) : "{cv_raw_start}"

    RÈGLES :
    1. Extrais toutes les langues et niveaux présents dans la SECTION LANGUES.
    2. Détecte la langue dans laquelle le CV est rédigé à partir du DÉBUT DU CV.
    3. Si la langue du CV n'est PAS dans la SECTION LANGUES, ajoute-la avec le niveau "Natif" ou "Langue maternelle".
    4. Ne jamais omettre la langue du CV.
  expected_output: >
    JSON : {{"langues": [{{"langue": "Français", "niveau": "Natif"}}, {{"langue": "Anglais", "niveau": "B2"}}]}}

identity_task:
  description: >
    Extrais le prénom du candidat.

    HEADER DU CV (nom, titre, contact) : "{header}"

    TEXTE BRUT DÉBUT DU CV : "{cv_raw_start}"

    NOM DU FICHIER (indice très fiable, souvent au format NOM_PRENOM_...) : "{file_name}"

    RÈGLES :
    1. Cherche le prénom dans le HEADER, puis dans le TEXTE BRUT DÉBUT DU CV.
    2. Le NOM DU FICHIER est un indice fort : "ANISSA_KACEM_..." → prénom = "Anissa".
    3. Ne jamais inventer. Formate avec majuscule initiale.
    4. Si impossible à trouver, retourne null.
  expected_output: >
    JSON : {{"first_name": "..."}}

poste_visé_task:
  description: >
    Extrais le titre de poste visé tel qu'il est écrit dans l'en-tête du CV.

    HEADER DU CV (extrait par le splitter) : "{header}"

    TEXTE BRUT DÉBUT DU CV (fallback si header vide) : "{cv_raw_start}"

    RÈGLES :
    1. Le titre de poste se trouve juste après le nom du candidat (ex: "Business Analyst", "Data Engineer").
    2. Copie le titre EXACTEMENT tel qu'il est écrit, sans reformuler.
    3. Si le header est vide, cherche dans le TEXTE BRUT DÉBUT DU CV.
    4. Ne jamais inventer un titre.
  expected_output: >
    JSON : {{
      "poste_vise": "Le titre EXACT tel qu'écrit sur le CV",
      "confiance": 90
    }}

# === partie matching ===

metier_matching_task:
  description: >
    Compare le profil du candidat avec le référentiel de métiers pour recommander les 3 postes les plus adaptés.

    POSTE VISÉ PAR LE CANDIDAT : "{poste_vise}"

    COMPÉTENCES DU CANDIDAT :
    Hard Skills : {hard_skills}
    Soft Skills : {soft_skills}

    DOMAINES DE COMPÉTENCES IDENTIFIÉS : {skill_domains}

    MÉTHODOLOGIES DU CANDIDAT : {methodologies}

    EXPÉRIENCES : {experiences_summary}

    PROJETS : {projects_summary}

    RECONVERSION : {reconversion_data}

    RÉFÉRENTIEL DE MÉTIERS :
    {metiers_reference}

    RÈGLES D'ANALYSE :
    IMPORTANT : Tu dois évaluer CHAQUE métier présent dans le RÉFÉRENTIEL DE MÉTIERS ci-dessus,
    sans en omettre aucun. Le top 3 final doit être basé sur l'évaluation exhaustive de tous
    les métiers listés. Ne jamais présélectionner ou ignorer des métiers a priori.

    1. Pour CHAQUE métier du référentiel, calcule un score de matching (0-100) basé sur :
       - Couverture des compétences techniques requises (35%)
       - Couverture des outils/technologies (25%)
       - Adéquation des expériences et projets (20%)
       - Maîtrise des méthodologies de travail : Agile, Scrum, DevOps, CI/CD, TDD, Design Thinking (10%)
       - Cohérence avec le niveau d'études et l'expérience requise (10%)
    2. Utilise le mapping de domaines pour comprendre les liens implicites (ex: Metabase → BI,
       LangChain → LLM Engineering, Power BI → BI Analyst, Scikit-learn → Data Science).
    3. Pour les profils en reconversion, valorise les compétences transférables
       (gestion d'équipe → leadership, optimisation de production → optimisation de processus data,
       communication internationale → travail en équipe multiculturelle).
    4. Recommande les 3 métiers avec le MEILLEUR score parmi l'ensemble du référentiel évalué.
    5. PONDÉRATION TEMPORELLE (CRITIQUE) : Accorde un poids double (x2) aux technologies et compétences issues des expériences et projets les plus récents, ainsi qu'à la formation en cours. Le profil actuel d'un candidat est défini par ce qu'il fait aujourd'hui, pas par son historique lointain.
    6. Pour chaque métier recommandé, liste les compétences matchées, manquantes, et les méthodologies.
    7. Si le poste visé par le candidat ne fait pas partie du top 3, explique pourquoi.
    8. Fournis une analyse détaillée de l'adéquation du poste visé avec le profil.
  expected_output: >
    JSON : {{
      "postes_recommandes": [
        {{
          "metier_id": "data_analyst",
          "nom": "Data Analyst",
          "categorie": "Noyau data & analytique",
          "score_matching": 85,
          "detail_scores": {{
            "competences_techniques": 80,
            "outils_technologies": 90,
            "experiences_projets": 85,
            "methodologies": 75
          }},
          "competences_matchees": ["SQL", "Python", "Power BI"],
          "competences_manquantes": ["Looker", "dbt"],
          "methodologies_matchees": ["Agile", "Scrum"],
          "justification": "Le profil couvre 85% des compétences requises..."
        }}
      ],
      "poste_vise_dans_top3": true,
      "analyse_poste_vise": "Analyse détaillée de l'adéquation..."
    }}

cv_quality_task:
  description: >
    Évalue la qualité globale du CV en appliquant les critères de bonnes pratiques CV tech 2025,
    adaptés au niveau de séniorité du candidat.

    CV COMPLET (texte Markdown) : "{cv_full_text}"

    TEXTE BRUT DU CV (première page, pour détecter les URLs et liens) : "{cv_raw_start}"

    COMPÉTENCES EXTRAITES AVEC CONTEXTE : {skills_with_context}
    EXPÉRIENCES : {experiences_summary}
    PROJETS : {projects_summary}
    NIVEAU DE SÉNIORITÉ : "{niveau_seniorite}"
    RECONVERSION : {reconversion_data}

    CRITÈRES D'ÉVALUATION (score sur 100 pour chaque) :

    1. COMPATIBILITÉ ATS (20 points) :
       - Structure claire avec sections standards ?
       - Pas de mise en page complexe qui bloquerait un ATS ?
       - Mots-clés techniques bien présents ?

    2. QUANTIFICATION DES RÉSULTATS (25 points) :
       - Les expériences mentionnent-elles des MÉTRIQUES TECHNIQUES SPÉCIFIQUES ?
         Cherche : réduction de latence (ms), amélioration du temps de chargement (%),
         optimisation de requêtes SQL (x fois plus rapide), volume d'utilisateurs supporté,
         réduction du temps de déploiement CI/CD, couverture de tests (%),
         réduction des coûts d'infrastructure, nombre de pipelines automatisés,
         volume de données traité, temps de réponse des APIs.
       - Donne des suggestions SPÉCIFIQUES de métriques que le candidat pourrait ajouter
         en fonction de ses expériences et projets RÉELS (pas des conseils génériques).

    3. STRUCTURE ET LISIBILITÉ (15 points) :
       - Le CV tient-il en 1-2 pages ?
       - Les sections sont-elles bien séparées et la chronologie claire ?
       - STRUCTURATION DES COMPÉTENCES : Les compétences sont-elles regroupées par catégories
         logiques (Langages, Frameworks, BDD, DevOps/Cloud, Méthodologies) ou en liste plate ?
         Une structuration par catégories est fortement recommandée pour les filtres ATS.

    4. PRÉSENTATION DES PROJETS (20 points) :
       - Chaque projet a-t-il un titre, des technos, et des résultats ?
       - Les projets sont-ils pertinents pour le poste visé ?
       - Y a-t-il une variété de projets (pro + perso) ?

    5. PREUVES DE COMPÉTENCES (20 points) :
       - RÈGLE CRITIQUE : Une compétence est considérée "sans preuve" UNIQUEMENT si elle
         apparaît EXCLUSIVEMENT dans la section Skills/Compétences sans aucune mention dans
         les expériences OU les projets. Utilise "skills_with_context" : si le contexte est
         "projet", "expérience", "académique" ou "projet+expérience", la compétence EST prouvée —
         ne la signale pas. Ne signale que les skills dont le contexte est "sans contexte".
       - DÉTECTION DES LIENS : Cherche les URLs dans le CV Markdown ET dans le texte brut.
         Les liens peuvent apparaître sous forme de Markdown [texte](url), de texte brut
         (github.com/..., linkedin.com/...) ou dans le header. Signale les liens PRÉSENTS,
         ne jamais conclure à l'absence de liens sans avoir vérifié les deux sources de texte.
       - Pour les RECONVERSIONS : les compétences transférables (management, optimisation,
         communication, gestion budgétaire) sont-elles mises en valeur et reliées au nouveau domaine ?

    ADAPTATION AU NIVEAU DE SÉNIORITÉ "{niveau_seniorite}" :
    - Si JUNIOR : valorise les projets personnels, formations, stages bien décrits.
    - Si CONFIRMÉ : exige des résultats mesurables, progression, responsabilités.
    - Si SENIOR/STAFF : vérifie la présence de choix architecturaux et compromis
      (systèmes distribués, microservices), leadership technique (mentoring, revues de code),
      gestion de la scalabilité, impact organisationnel au-delà du code.

    RED FLAGS À DÉTECTER :
    - Skills listées UNIQUEMENT dans la section skills sans aucune mention dans expériences/projets
    - Trous inexpliqués dans le parcours
    - Jargon excessif ou buzzwords sans substance
    - Incohérence entre compétences listées et projets/expériences
    - Section compétences en liste plate non catégorisée
  expected_output: >
    JSON : {{
      "score_global": 72,
      "compatibilite_ats": {{ "score": 80, "details": "..." }},
      "quantification_resultats": {{ "score": 50, "details": "...", "metriques_suggerees": ["Préciser le temps de réponse des dashboards PowerBI", "Quantifier le volume de données traité par les flows Dataiku"] }},
      "structure_lisibilite": {{ "score": 85, "details": "...", "structuration_competences": "Compétences bien catégorisées par domaine" }},
      "presentation_projets": {{ "score": 70, "details": "..." }},
      "preuves_competences": {{ "score": 65, "details": "...", "skills_sans_preuve": ["skill_hors_contexte_uniquement"], "liens_detectes": ["github.com/user", "linkedin.com/in/user"] }},
      "red_flags": ["..."],
      "points_forts": ["..."],
      "conseils_prioritaires": ["Conseil spécifique et actionnable 1", "Conseil spécifique 2"],
      "adaptation_seniorite": "Analyse adaptée au profil confirmé..."
    }}

project_analysis_task:
  description: >
    Évalue CHAQUE projet du CV et détermine leur pertinence pour le poste visé.

    POSTE VISÉ : "{poste_vise}"

    RÉFÉRENTIEL DU MÉTIER VISÉ (compétences et outils attendus) :
    {metier_reference_detail}

    PROJETS PROFESSIONNELS : {professional_projects}
    PROJETS PERSONNELS : {personal_projects}

    RECONVERSION : {reconversion_data}

    Pour CHAQUE projet, fournis :
    1. score_coherence (0-100) : cohérence avec le poste visé et le référentiel métier
    2. rang : classement par ORDRE DE PERTINENCE pour le poste (1 = le plus pertinent pour ce poste)
    3. raison : explication CONCISE de pourquoi ce projet doit être mis en avant (ou pas) pour ce poste visé
    4. points_forts : atouts concrets (technologies démontrées, impact, qualité)
    5. points_amelioration : ce qui manque pour convaincre (métriques, résultats, détails techniques)
    6. conseils_description : conseils CONCRETS pour améliorer la description
       (métriques à ajouter, aspects techniques à détailler, résultats à valoriser)

    RÈGLES STRICTES :
    - N'analyse QUE les projets listés dans PROJETS PROFESSIONNELS et PROJETS PERSONNELS.
    - N'invente AUCUN projet à partir des expériences. Les expériences sont un contexte uniquement.
    - Si PROJETS PROFESSIONNELS et PROJETS PERSONNELS sont vides, retourne "analyse_projets": [].
    - Le nombre d'entrées dans "analyse_projets" doit correspondre EXACTEMENT au nombre de projets fournis.
    - Retourne les projets TRIÉS par rang (rang 1 en premier).
  expected_output: >
    JSON : {{
      "analyse_projets": [
        {{
          "titre": "Dashboard RH",
          "rang": 1,
          "raison": "Projet BI directement aligné avec les outils et missions du poste visé",
          "score_coherence": 90,
          "points_forts": ["SQL et Power BI maîtrisés et démontrés", "Impact mesurable sur les décisions RH"],
          "points_amelioration": ["Ajouter le volume de données traité", "Mentionner le temps de chargement"],
          "conseils_description": ["Préciser le volume de données traité (ex: 500k lignes)", "Ajouter une métrique de performance"]
        }}
      ],
      "coherence_globale": {{
        "score": 85,
        "commentaire": "Ensemble de projets cohérent avec le poste visé"
      }}
    }}

